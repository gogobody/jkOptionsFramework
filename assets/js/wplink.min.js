(function(f,r,K){function D(){return g?g.$('a[data-wplink-edit="true"]'):null}var g,E,v,F=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,63}$/i,G=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,63}[^ "]*$/i,l,w,t,u,x,m,h,H,y,n,z,A,B,p,q,I,L="ontouchend"in document;window.wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",modalOpen:!1,init:function(){l=f("#wp-link-wrap");w=f("#wp-link");t=f("#wp-link-backdrop");u=f("#wp-link-submit");x=f("#wp-link-close");
m=f("#wp-link-text");h=f("#wp-link-url");H=f("#_ajax_linking_nonce");y=f("#wp-link-target");n=f("#wp-link-search");p=new C(f("#search-results"));q=new C(f("#most-recent-results"));I=w.find(".query-results");z=f("#query-notice-message");A=z.find(".query-notice-default");B=z.find(".query-notice-hint");w.on("keydown",wpLink.keydown);w.on("keyup",wpLink.keyup);u.on("click",function(a){a.preventDefault();wpLink.update()});x.add(t).add("#wp-link-cancel button").on("click",function(a){a.preventDefault();
wpLink.close()});I.on("river-select",wpLink.updateFields);n.on("focus.wplink",function(){A.hide();B.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){A.show();B.addClass("screen-reader-text").hide()});n.on("keyup input",function(){window.clearTimeout(E);E=window.setTimeout(function(){wpLink.searchInternalLinks()},500)});h.on("paste",function(){setTimeout(wpLink.correctURL,0)});h.on("blur",wpLink.correctURL)},correctURL:function(){var a=h.val().trim();a&&v!==a&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(a)&&
(h.val("http://"+a),v=a)},open:function(a,b,c){var e=f(document.body);e.addClass("modal-open");wpLink.modalOpen=!0;wpLink.range=null;a&&(window.wpActiveEditor=a);window.wpActiveEditor&&(this.textarea=f("#"+window.wpActiveEditor).get(0),"undefined"!==typeof window.tinymce&&(e.append(t,l),g=(a=window.tinymce.get(window.wpActiveEditor))&&!a.isHidden()?a:null),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),l.show(),t.show(),wpLink.refresh(b,c),
f(document).trigger("wplink-open",l))},isMCE:function(){return g&&!g.isHidden()},refresh:function(a,b){p.refresh();q.refresh();wpLink.isMCE()?wpLink.mceRefresh(a,b):(l.hasClass("has-text-field")||l.addClass("has-text-field"),document.selection?document.selection.createRange():"undefined"!==typeof this.textarea.selectionStart&&this.textarea.selectionStart!==this.textarea.selectionEnd&&(b=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||b||""),m.val(b),wpLink.setDefaultValues());
L?h.trigger("focus").trigger("blur"):window.setTimeout(function(){h[0].select();h.trigger("focus")});q.ul.children().length||q.ajax();v=h.val().replace(/^http:\/\//,"")},hasSelectedText:function(a){var b;var c=g.selection.getContent();if(/</.test(c)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(c)||-1===c.indexOf("href=")))return!1;if(a.length){c=a[0].childNodes;if(!c||!c.length)return!1;for(b=c.length-1;0<=b;b--)if(a=c[b],3!=a.nodeType&&!window.tinymce.dom.BookmarkManager.isBookmarkNode(a))return!1}return!0},
mceRefresh:function(a,b){var c=D(),e=this.hasSelectedText(c);if(c.length){var d=c.text();var k=c.attr("href");d.trim()||(d=b||"");a&&(G.test(a)||F.test(a))&&(k=a);"_wp_link_placeholder"!==k?(h.val(k),y.prop("checked","_blank"===c.attr("target")),u.val(r.update)):this.setDefaultValues(d);a&&a!==k?n.val(a):n.val("");window.setTimeout(function(){wpLink.searchInternalLinks()})}else d=g.selection.getContent({format:"text"})||b||"",this.setDefaultValues(d);e?(m.val(d),l.addClass("has-text-field")):(m.val(""),
l.removeClass("has-text-field"))},close:function(a){f(document.body).removeClass("modal-open");wpLink.modalOpen=!1;"noReset"!==a&&(wpLink.isMCE()?(g.plugins.wplink&&g.plugins.wplink.close(),g.focus()):(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select())));t.hide();l.hide();v=!1;f(document).trigger("wplink-close",l)},getAttrs:function(){wpLink.correctURL();return{href:h.val().trim(),target:y.prop("checked")?"_blank":null}},buildHtml:function(a){var b=
'<a href="'+a.href+'"';a.target&&(b+=' rel="noopener" target="'+a.target+'"');return b+">"},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var a=wpLink.textarea;if(a){var b=wpLink.getAttrs();var c=m.val();var e=document.createElement("a");e.href=b.href;if("javascript:"===e.protocol||"data:"===e.protocol)b.href="";if(b.href){b=wpLink.buildHtml(b);if(document.selection&&wpLink.range)a.focus(),wpLink.range.text=b+(c||wpLink.range.text)+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),
wpLink.range.select(),wpLink.range=null;else if("undefined"!==typeof a.selectionStart){e=a.selectionStart;var d=a.selectionEnd;var k=c||a.value.substring(e,d);b=b+k+"</a>";c=e+b.length;e!==d||k||(c-=4);a.value=a.value.substring(0,e)+b+a.value.substring(d,a.value.length);a.selectionStart=a.selectionEnd=c}wpLink.close();a.focus();f(a).trigger("change")}}},mceUpdate:function(){var a=wpLink.getAttrs(),b,c,e=document.createElement("a");e.href=a.href;if("javascript:"===e.protocol||"data:"===e.protocol)a.href=
"";if(a.href){var d=D();g.undoManager.transact(function(){d.length||(g.execCommand("mceInsertLink",!1,{href:"_wp_link_placeholder","data-wp-temp-link":1}),d=g.$('a[data-wp-temp-link="1"]').removeAttr("data-wp-temp-link"),c=d.text().trim());d.length?(l.hasClass("has-text-field")&&((b=m.val())?d.text(b):c||d.text(a.href)),a["data-wplink-edit"]=null,a["data-mce-href"]=a.href,d.attr(a)):g.execCommand("unlink")});wpLink.close("noReset");g.focus();d.length&&(g.selection.select(d[0]),g.plugins.wplink&&g.plugins.wplink.checkLink(d[0]));
g.nodeChanged();K.a11y.speak(r.linkInserted)}else g.execCommand("unlink"),wpLink.close()},updateFields:function(a,b){h.val(b.children(".item-permalink").val());l.hasClass("has-text-field")&&!m.val()&&m.val(b.children(".item-title").text())},getUrlFromSelection:function(a){a||(this.isMCE()?a=g.selection.getContent({format:"text"}):document.selection&&wpLink.range?a=wpLink.range.text:"undefined"!==typeof this.textarea.selectionStart&&(a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)));
return(a=(a||"").trim())&&F.test(a)?"mailto:"+a:a&&G.test(a)?a.replace(/&amp;|&#0?38;/gi,"&"):""},setDefaultValues:function(a){h.val(this.getUrlFromSelection(a));n.val("");wpLink.searchInternalLinks();u.val(r.save)},searchInternalLinks:function(){var a=n.val()||"",b=parseInt(r.minInputLength,10)||3;if(a.length>=b){if(q.hide(),p.show(),wpLink.lastSearch!=a){wpLink.lastSearch=a;var c=n.parent().find(".spinner").addClass("is-active");p.change(a);p.ajax(function(){c.removeClass("is-active")})}}else p.hide(),
q.show()},next:function(){p.next();q.next()},prev:function(){p.prev();q.prev()},keydown:function(a){if(27===a.keyCode)wpLink.close(),a.stopImmediatePropagation();else if(9===a.keyCode){var b=a.target.id;"wp-link-submit"!==b||a.shiftKey?"wp-link-close"===b&&a.shiftKey&&(u.trigger("focus"),a.preventDefault()):(x.trigger("focus"),a.preventDefault())}a.shiftKey||38!==a.keyCode&&40!==a.keyCode||document.activeElement&&("link-title-field"===document.activeElement.id||"url-field"===document.activeElement.id)||
(b=38===a.keyCode?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[b](),wpLink.keyInterval=setInterval(wpLink[b],wpLink.keySensitivity),a.preventDefault())},keyup:function(a){if(38===a.keyCode||40===a.keyCode)clearInterval(wpLink.keyInterval),a.preventDefault()},delayedCallback:function(a,b){var c,e,d,k;if(!b)return a;setTimeout(function(){if(e)return a.apply(k,d);c=!0},b);return function(){if(c)return a.apply(this,arguments);d=arguments;k=this;e=!0}}};var C=function(a,b){var c=this;this.element=
a;this.ul=a.children("ul");this.contentHeight=a.children("#link-selector-height");this.waiting=a.find(".river-waiting");this.change(b);this.refresh();f("#wp-link .query-results, #wp-link #link-selector").on("scroll",function(){c.maybeLoad()});a.on("click","li",function(e){c.select(f(this),e)})};f.extend(C.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide();
this.visible=!1},select:function(a,b){if(!a.hasClass("unselectable")&&a!=this.selected){this.deselect();this.selected=a.addClass("selected");var c=a.outerHeight();var e=this.element.height();var d=a.position().top;var k=this.element.scrollTop();0>d?this.element.scrollTop(k+d):d+c>e&&this.element.scrollTop(k+d-e+c);this.element.trigger("river-select",[a,b,this])}},deselect:function(){this.selected&&this.selected.removeClass("selected");this.selected=!1},prev:function(){if(this.visible&&this.selected){var a=
this.selected.prev("li");a.length&&this.select(a)}},next:function(){if(this.visible){var a=this.selected?this.selected.next("li"):f("li:not(.unselectable):first",this.element);a.length&&this.select(a)}},ajax:function(a){var b=this,c=wpLink.delayedCallback(function(e,d){b.process(e,d);a&&a(e,d)},1==this.query.page?0:wpLink.minRiverAJAXDuration);this.query.ajax(c)},change:function(a){this.query&&this._search==a||(this._search=a,this.query=new J(a),this.element.scrollTop(0))},process:function(a,b){var c=
"",e=!0,d="";b=1==b.page;a?f.each(a,function(){d=e?"alternate":"";d+=this.title?"":" no-title";c+=d?'<li class="'+d+'">':"<li>";c+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';c+='<span class="item-title">';c+=this.title?this.title:r.noTitle;c+='</span><span class="item-info">'+this.info+"</span></li>";e=!e}):b&&(c+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+r.noMatchesFound+"</em></span></li>");this.ul[b?"html":"append"](c)},maybeLoad:function(){var a=
this,b=this.element,c=b.scrollTop()+b.height();!this.query.ready()||c<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout(function(){var e=b.scrollTop(),d=e+b.height();!a.query.ready()||d<a.contentHeight.height()-wpLink.riverBottomThreshold||(a.waiting.addClass("is-active"),b.scrollTop(e+a.waiting.outerHeight()),a.ajax(function(){a.waiting.removeClass("is-active")}))},wpLink.timeToTriggerRiver)}});var J=function(a){this.page=1;this.querying=this.allLoaded=!1;this.search=a};f.extend(J.prototype,
{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(a){var b=this,c={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:H.val()};this.search&&(c.search=this.search);this.querying=!0;f.post(window.ajaxurl,c,function(e){b.page++;b.querying=!1;b.allLoaded=!e;a(e,c)},"json")}});f(wpLink.init)})(jQuery,window.wpLinkL10n,window.wp);
